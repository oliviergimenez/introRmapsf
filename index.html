<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>GIS and mapping in R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Olivier Gimenez" />
    <meta name="date" content="2020-10-30" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <script src="libs/htmlwidgets/htmlwidgets.js"></script>
    <script src="libs/jquery/jquery.min.js"></script>
    <link href="libs/leaflet/leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet/leaflet.js"></script>
    <link href="libs/leafletfix/leafletfix.css" rel="stylesheet" />
    <script src="libs/proj4/proj4.min.js"></script>
    <script src="libs/Proj4Leaflet/proj4leaflet.js"></script>
    <link href="libs/rstudio_leaflet/rstudio_leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-binding/leaflet.js"></script>
    <script src="libs/leaflet-providers/leaflet-providers_1.9.0.js"></script>
    <script src="libs/leaflet-providers-plugin/leaflet-providers-plugin.js"></script>
    <script src="libs/FlatGeoBuf/fgb.js"></script>
    <script src="libs/FlatGeoBuf/flatgeobuf-geojson.min.js"></script>
    <script src="libs/chromajs/chroma.min.js"></script>
    <link id="covariates-bearpresence-1-attachment" rel="attachment" href="libs/covariates-bearpresence/covariates-bearpresence_layer.fgb"/>
    <link href="libs/HomeButton/home-button.css" rel="stylesheet" />
    <script src="libs/HomeButton/home-button.js"></script>
    <script src="libs/HomeButton/easy-button-src.min.js"></script>
    <script src="libs/clipboard/setClipboardText.js"></script>
    <link href="libs/mapviewCSS/mapview-popup.css" rel="stylesheet" />
    <link href="libs/mapviewCSS/mapview.css" rel="stylesheet" />
    <link id="covariates-forestcover-1-attachment" rel="attachment" href="libs/covariates-forestcover/covariates-forestcover_layer.fgb"/>
    <link rel="stylesheet" href="css/rutgers-tidyverse.css" type="text/css" />
    <link rel="stylesheet" href="css/rutgers-fonts_og.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# GIS and mapping in R
## Introduction to the sf package
### Olivier Gimenez
### 2020-10-30

---





# Simple Features for R: the sf package

&lt;img src="img/sfcartoon.jpg" width="700px" style="display: block; margin: auto;" /&gt;

---
class: inverse, middle, center
# Introduction
---


# What's so nice about `sf`?

* Easy to work with spatial data because the distinction between spatial data and other forms of data is minimized

* Spatial objects are stored as **dataframes**, with the feature geometries stored in list-columns

* This is similar to the way that **spatial databases** are structured

* All functions begin with `st_` for easy autofill with RStudio tab 

* Functions are **pipe-friendly**

* `dplyr` and `tidyr` verbs have been defined for the `sf` objects

* `ggplot2` is able to plot `sf` objects directly

&lt;img src="img/animatedsf.gif" width="100px" style="display: block; margin: auto;" /&gt;


---

# Load packages


```r
library(sf) # GIS package
```

```
## Linking to GEOS 3.8.1, GDAL 3.1.4, PROJ 6.3.1
```

```r
library(tidyverse) # tidyverse packages, dplyr and ggplot2 among others
```

```
## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──
```

```
## ✓ ggplot2 3.3.3     ✓ purrr   0.3.4
## ✓ tibble  3.1.1     ✓ dplyr   1.0.6
## ✓ tidyr   1.1.3     ✓ stringr 1.4.0
## ✓ readr   1.4.0     ✓ forcats 0.5.1
```

```
## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()
```

```r
theme_set(theme_minimal()) # set ggplot theme 
```


---

## Vector layers in `sf`

* The `sf` class is a hierarchical structure composed of 3 classes 
    * In green, **sf** - Vector layer object, `data.frame` with `\(\geq 1\)` attribute columns and 1 geometry column
    * In red, **sfc** - Geometric part of vector layer - geometry column
    * In blue, **sfg** - Geometry of individual [simple feature](https://en.wikipedia.org/wiki/Simple_Features)

&lt;img src="img/sf_xfig.png" width="1497" style="display: block; margin: auto;" /&gt;


---

## Simple feature geometry **`sfg`**

&lt;img src="index_files/figure-html/unnamed-chunk-5-1.png" width="550px" style="display: block; margin: auto;" /&gt;


---
class: inverse, middle, center
# First steps
---


# Case study

&lt;img src="img/oryxpaper.png" width="800px" style="display: block; margin: auto;" /&gt;

---

# Read in spatial data


```r
studysites_raw &lt;- st_read("shp/bearpyrenees.shp")
```

```
## Reading layer `bearpyrenees' from data source `/Users/loulou/Travail/R/intro_spatialR/shp/bearpyrenees.shp' using driver `ESRI Shapefile'
## Simple feature collection with 138 features and 4 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 315722.7 ymin: 1704775 xmax: 644368 ymax: 1800721
## Projected CRS: Lambert_Conformal_Conic
```

---

# Examine structure


```r
glimpse(studysites_raw)
```

```
## Rows: 138
## Columns: 5
## $ Numero     &lt;dbl&gt; 640101, 640102, 640203, 640204, 640202, 640201, 640301, 640…
## $ pres_08_12 &lt;chr&gt; "Absence", "Absence", "Occasionnelle", "Occasionnelle", "Ab…
## $ Perimeter  &lt;dbl&gt; 53446.71, 60814.07, 38908.05, 32749.40, 36869.03, 37629.04,…
## $ Iti2012    &lt;int&gt; NA, NA, 1, 1, NA, NA, NA, 1, 1, 1, 1, NA, 0, 1, 1, 1, 1, 1,…
## $ geometry   &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((315785.1 17..., MULTIPOLYGON (…
```

---

# Examine structure


```r
studysites_raw
```

```
## Simple feature collection with 138 features and 4 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 315722.7 ymin: 1704775 xmax: 644368 ymax: 1800721
## Projected CRS: Lambert_Conformal_Conic
## First 10 features:
##    Numero    pres_08_12 Perimeter Iti2012                       geometry
## 1  640101       Absence  53446.71      NA MULTIPOLYGON (((315785.1 17...
## 2  640102       Absence  60814.07      NA MULTIPOLYGON (((326069.1 17...
## 3  640203 Occasionnelle  38908.05       1 MULTIPOLYGON (((328868.9 17...
## 4  640204 Occasionnelle  32749.40       1 MULTIPOLYGON (((338223.2 17...
## 5  640202       Absence  36869.03      NA MULTIPOLYGON (((348261.2 17...
## 6  640201       Absence  37629.04      NA MULTIPOLYGON (((347345.4 17...
## 7  640301       Absence  29586.76      NA MULTIPOLYGON (((350581.2 17...
## 8  640302       Absence  25304.44       1 MULTIPOLYGON (((353106.3 17...
## 9  640401 Occasionnelle  44181.28       1 MULTIPOLYGON (((353084 1783...
## 10 640402     Reguliere  43850.75       1 MULTIPOLYGON (((359081.4 17...
```


---

# Select relevant columns


```r
studysites &lt;- studysites_raw %&gt;%
* select('bearpresence' = pres_08_12,
*        'idsite' = Numero)
studysites
```

```
## Simple feature collection with 138 features and 2 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 315722.7 ymin: 1704775 xmax: 644368 ymax: 1800721
## Projected CRS: Lambert_Conformal_Conic
## First 10 features:
##     bearpresence idsite                       geometry
## 1        Absence 640101 MULTIPOLYGON (((315785.1 17...
## 2        Absence 640102 MULTIPOLYGON (((326069.1 17...
## 3  Occasionnelle 640203 MULTIPOLYGON (((328868.9 17...
## 4  Occasionnelle 640204 MULTIPOLYGON (((338223.2 17...
## 5        Absence 640202 MULTIPOLYGON (((348261.2 17...
## 6        Absence 640201 MULTIPOLYGON (((347345.4 17...
## 7        Absence 640301 MULTIPOLYGON (((350581.2 17...
## 8        Absence 640302 MULTIPOLYGON (((353106.3 17...
## 9  Occasionnelle 640401 MULTIPOLYGON (((353084 1783...
## 10     Reguliere 640402 MULTIPOLYGON (((359081.4 17...
```

---

# Our first map


```r
studysites %&gt;%
* ggplot() +
* geom_sf() +
  labs(title = 'Brown bear monitoring sites in the French Pyrenees mountains',
       subtitle = 'Source: French Game and Wildlife Agency')
```

&lt;img src="index_files/figure-html/unnamed-chunk-11-1.png" style="display: block; margin: auto;" /&gt;

---

# Where did the species occur?


```r
studysites %&gt;%
  ggplot() +
* geom_sf(aes(fill = bearpresence)) +
  labs(title = 'Brown bear presence in the French Pyrenees mountains',
       subtitle = 'Source: French Game and Wildlife Agency')
```

&lt;img src="index_files/figure-html/unnamed-chunk-12-1.png" style="display: block; margin: auto;" /&gt;

---

# Where did the species occur?


```r
studysites %&gt;%
  ggplot() +
  geom_sf(aes(fill = bearpresence)) + 
  labs(title = 'Brown bear presence in the French Pyrenees mountains',
       subtitle = 'Source: French Game and Wildlife Agency',
*      fill = "Presence")
```

&lt;img src="index_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /&gt;



---

# Take control of your legends


```r
studysites %&gt;%
  ggplot() +
  geom_sf(aes(fill = bearpresence)) +
  labs(title = 'Brown bear presence in the French Pyrenees mountains',
       subtitle = 'Source: French Game and Wildlife Agency') +
* scale_fill_manual(values = c('gray90','steelblue1','steelblue4'),
*                   name = "Bear presence",
*                   labels = c("Absent", "Occasional", "Regular"))
```

&lt;img src="index_files/figure-html/unnamed-chunk-14-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse, middle, center
# Spatial operations: transform, crop, intersect, join
---

# Forest cover

* Forest cover might be a driver of brown bear distribution

* We use corine land cover (CLC) data (2012 version) to get forest cover

* Data can be downloaded [from the official website](http://www.donnees.statistiques.developpement-durable.gouv.fr/donneesCLC/CLC/millesime/CLC12_FR_RGF_SHP.zip)

* An explanation of what's in the data is available [here](https://www.statistiques.developpement-durable.gouv.fr/sites/default/files/2019-07/Nomenclature_CLC.pdf).  

---

# Read in data


```r
clc2012 &lt;- st_read("shp/CLC12_FR_RGF.shp")
```

```
## Reading layer `CLC12_FR_RGF' from data source `/Users/loulou/Travail/R/intro_spatialR/shp/CLC12_FR_RGF.shp' using driver `ESRI Shapefile'
## Simple feature collection with 274573 features and 3 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 73767.79 ymin: 6021170 xmax: 1267595 ymax: 7133490
## Projected CRS: RGF93_Lambert_93
```

---

# Read in data


```r
clc2012
```

```
## Simple feature collection with 274573 features and 3 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 73767.79 ymin: 6021170 xmax: 1267595 ymax: 7133490
## Projected CRS: RGF93_Lambert_93
## First 10 features:
##           ID CODE_12      AREA_HA                       geometry
## 1  FR-274573     523 4.879872e+06 POLYGON ((657640.6 7133490,...
## 2  FR-271961     423 8.555978e+02 POLYGON ((669050 7111012, 6...
## 3  FR-265902     331 3.092622e+02 POLYGON ((669132.3 7110834,...
## 4  FR-250624     322 7.593459e+01 POLYGON ((669181.5 7110656,...
## 5  FR-250623     322 1.826213e+02 POLYGON ((666715.4 7109580,...
## 6   FR-25381     112 3.282088e+02 POLYGON ((666715.4 7109580,...
## 7  FR-265901     331 2.503051e+01 POLYGON ((667326.7 7108770,...
## 8  FR-147959     242 6.157960e+01 POLYGON ((669097.7 7109171,...
## 9  FR-270463     333 2.949202e+01 POLYGON ((666773.8 7109345,...
## 10  FR-62513     211 9.808718e+05 POLYGON ((669737.1 7108874,...
```

---

# Extract forest codes

```r
forest &lt;- clc2012 %&gt;%
* filter(CODE_12 == '311' | CODE_12 == '312' | CODE_12 == '313')
forest
```

```
## Simple feature collection with 69111 features and 3 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 125951.9 ymin: 6021917 xmax: 1243919 ymax: 7100648
## Projected CRS: RGF93_Lambert_93
## First 10 features:
##           ID CODE_12    AREA_HA                       geometry
## 1  FR-211653     311  114.81939 POLYGON ((657867.2 7100629,...
## 2  FR-227070     312   29.01440 POLYGON ((632270.7 7100616,...
## 3  FR-211652     311   36.78086 POLYGON ((630186.3 7100313,...
## 4  FR-211651     311   90.71384 POLYGON ((625545 7098175, 6...
## 5  FR-211650     311   32.23925 POLYGON ((660260.8 7097323,...
## 6  FR-211649     311   43.00924 POLYGON ((607150.2 7090018,...
## 7  FR-211648     311   25.39949 POLYGON ((626532.2 7086540,...
## 8  FR-211647     311   45.10054 POLYGON ((669017.5 7085727,...
## 9  FR-211646     311 1005.69349 POLYGON ((618120.9 7082302,...
## 10 FR-211645     311   62.38459 POLYGON ((603423.4 7085365,...
```

---

# Use same coordinates system for map of the Pyrénées and forest layer

```r
studysites &lt;- studysites %&gt;% 
* st_transform(crs = st_crs(forest))
studysites
```

```
## Simple feature collection with 138 features and 2 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 362039 ymin: 6139034 xmax: 690160.2 ymax: 6235505
## Projected CRS: RGF93_Lambert_93
## First 10 features:
##     bearpresence idsite                       geometry
## 1        Absence 640101 MULTIPOLYGON (((362110.5 62...
## 2        Absence 640102 MULTIPOLYGON (((372352.1 62...
## 3  Occasionnelle 640203 MULTIPOLYGON (((375125.4 62...
## 4  Occasionnelle 640204 MULTIPOLYGON (((384447.4 62...
## 5        Absence 640202 MULTIPOLYGON (((394521 6219...
## 6        Absence 640201 MULTIPOLYGON (((393646.7 62...
## 7        Absence 640301 MULTIPOLYGON (((396923.9 62...
## 8        Absence 640302 MULTIPOLYGON (((399383.2 62...
## 9  Occasionnelle 640401 MULTIPOLYGON (((399338.3 62...
## 10     Reguliere 640402 MULTIPOLYGON (((405268.8 62...
```

---

# Calculate area of each site

```r
studysites %&gt;% 
* mutate(area = st_area(.),
         .before = 1)
```

```
## Simple feature collection with 138 features and 3 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 362039 ymin: 6139034 xmax: 690160.2 ymax: 6235505
## Projected CRS: RGF93_Lambert_93
## First 10 features:
##               area  bearpresence idsite                       geometry
## 1   79618924 [m^2]       Absence 640101 MULTIPOLYGON (((362110.5 62...
## 2  122155210 [m^2]       Absence 640102 MULTIPOLYGON (((372352.1 62...
## 3   64012619 [m^2] Occasionnelle 640203 MULTIPOLYGON (((375125.4 62...
## 4   36208552 [m^2] Occasionnelle 640204 MULTIPOLYGON (((384447.4 62...
## 5   67904470 [m^2]       Absence 640202 MULTIPOLYGON (((394521 6219...
## 6   58455872 [m^2]       Absence 640201 MULTIPOLYGON (((393646.7 62...
## 7   30310636 [m^2]       Absence 640301 MULTIPOLYGON (((396923.9 62...
## 8   25866722 [m^2]       Absence 640302 MULTIPOLYGON (((399383.2 62...
## 9   72321198 [m^2] Occasionnelle 640401 MULTIPOLYGON (((399338.3 62...
## 10  67797321 [m^2]     Reguliere 640402 MULTIPOLYGON (((405268.8 62...
```

---

# Convert area in km&lt;sup&gt;2&lt;/sup&gt;

```r
studysites %&gt;% 
  mutate(.before = 1,
         area = st_area(.),
*        areakm2 = units::set_units(area, km^2))
```

```
## Simple feature collection with 138 features and 4 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 362039 ymin: 6139034 xmax: 690160.2 ymax: 6235505
## Projected CRS: RGF93_Lambert_93
## First 10 features:
##               area          areakm2  bearpresence idsite
## 1   79618924 [m^2]  79.61892 [km^2]       Absence 640101
## 2  122155210 [m^2] 122.15521 [km^2]       Absence 640102
## 3   64012619 [m^2]  64.01262 [km^2] Occasionnelle 640203
## 4   36208552 [m^2]  36.20855 [km^2] Occasionnelle 640204
## 5   67904470 [m^2]  67.90447 [km^2]       Absence 640202
## 6   58455872 [m^2]  58.45587 [km^2]       Absence 640201
## 7   30310636 [m^2]  30.31064 [km^2]       Absence 640301
## 8   25866722 [m^2]  25.86672 [km^2]       Absence 640302
## 9   72321198 [m^2]  72.32120 [km^2] Occasionnelle 640401
## 10  67797321 [m^2]  67.79732 [km^2]     Reguliere 640402
##                          geometry
## 1  MULTIPOLYGON (((362110.5 62...
## 2  MULTIPOLYGON (((372352.1 62...
## 3  MULTIPOLYGON (((375125.4 62...
## 4  MULTIPOLYGON (((384447.4 62...
## 5  MULTIPOLYGON (((394521 6219...
## 6  MULTIPOLYGON (((393646.7 62...
## 7  MULTIPOLYGON (((396923.9 62...
## 8  MULTIPOLYGON (((399383.2 62...
## 9  MULTIPOLYGON (((399338.3 62...
## 10 MULTIPOLYGON (((405268.8 62...
```

---

# Define big sites (area &gt; 300 km&lt;sup&gt;2&lt;/sup&gt;)

```r
studysites &lt;- studysites %&gt;% 
  mutate(.before = 1,
         area = st_area(.),
         areakm2 = units::set_units(area, km^2),
*        bigsites = ifelse(as.numeric(areakm2) &gt; 300, areakm2, NA))
studysites
```

```
## Simple feature collection with 138 features and 5 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 362039 ymin: 6139034 xmax: 690160.2 ymax: 6235505
## Projected CRS: RGF93_Lambert_93
## First 10 features:
##               area          areakm2 bigsites  bearpresence idsite
## 1   79618924 [m^2]  79.61892 [km^2]       NA       Absence 640101
## 2  122155210 [m^2] 122.15521 [km^2]       NA       Absence 640102
## 3   64012619 [m^2]  64.01262 [km^2]       NA Occasionnelle 640203
## 4   36208552 [m^2]  36.20855 [km^2]       NA Occasionnelle 640204
## 5   67904470 [m^2]  67.90447 [km^2]       NA       Absence 640202
## 6   58455872 [m^2]  58.45587 [km^2]       NA       Absence 640201
## 7   30310636 [m^2]  30.31064 [km^2]       NA       Absence 640301
## 8   25866722 [m^2]  25.86672 [km^2]       NA       Absence 640302
## 9   72321198 [m^2]  72.32120 [km^2]       NA Occasionnelle 640401
## 10  67797321 [m^2]  67.79732 [km^2]       NA     Reguliere 640402
##                          geometry
## 1  MULTIPOLYGON (((362110.5 62...
## 2  MULTIPOLYGON (((372352.1 62...
## 3  MULTIPOLYGON (((375125.4 62...
## 4  MULTIPOLYGON (((384447.4 62...
## 5  MULTIPOLYGON (((394521 6219...
## 6  MULTIPOLYGON (((393646.7 62...
## 7  MULTIPOLYGON (((396923.9 62...
## 8  MULTIPOLYGON (((399383.2 62...
## 9  MULTIPOLYGON (((399338.3 62...
## 10 MULTIPOLYGON (((405268.8 62...
```





---
# Map again, with area on top of big sites

```r
studysites %&gt;%
  ggplot() + 
  geom_sf() +
* geom_sf_label(aes(label = round(bigsites))) +
  labs(title = 'Brown bear big monitoring sites in the French Pyrenees mountains',
       subtitle = 'Big sites have area &gt; 300km2',
       caption = 'Data from: French Game and Wildlife Agency',
       x = "", y = "")
```

&lt;img src="index_files/figure-html/unnamed-chunk-23-1.png" style="display: block; margin: auto;" /&gt;

---

# Crop forest to match study area boundaries

```r
forest %&gt;% 
* st_crop(st_bbox(studysites)) %&gt;%
  as_tibble()
```

```
## # A tibble: 2,504 x 4
##    ID       CODE_12 AREA_HA                                             geometry
##    &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;                                       &lt;GEOMETRY [m]&gt;
##  1 FR-1744… 311       2807. MULTIPOLYGON (((479636.9 6235505, 479719.6 6235430,…
##  2 FR-1744… 311       2409. POLYGON ((442252.5 6235505, 442429.7 6235438, 44254…
##  3 FR-1743… 311       2843. MULTIPOLYGON (((396335.1 6235505, 396346.2 6235435,…
##  4 FR-1742… 311        476. POLYGON ((471577.9 6235505, 471467.3 6235289, 47137…
##  5 FR-1742… 311        588. POLYGON ((490987.1 6235505, 491006.8 6235337, 49098…
##  6 FR-1742… 311        354. MULTIPOLYGON (((484715.2 6235505, 484694.9 6235499,…
##  7 FR-1742… 311        579. MULTIPOLYGON (((500091.4 6235505, 500058.3 6235481,…
##  8 FR-1741… 311        357. POLYGON ((509149.7 6235505, 509148.6 6235486, 50933…
##  9 FR-1741… 311       6202. MULTIPOLYGON (((379133.9 6235505, 379132.4 6235483,…
## 10 FR-1741… 311        292. POLYGON ((451256.3 6235505, 451260.6 6235447, 45126…
## # … with 2,494 more rows
```

---

# Then intersect the two layers

```r
forest %&gt;% 
  st_crop(st_bbox(studysites)) %&gt;%
* st_intersection(studysites) %&gt;%
  as_tibble()
```

```
## # A tibble: 2,177 x 9
##    ID        CODE_12 AREA_HA     area  areakm2 bigsites bearpresence idsite
##    &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;    [m^2]   [km^2]    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;
##  1 FR-173974 311       243.  79618924 79.61892       NA Absence      640101
##  2 FR-173874 311     18041.  79618924 79.61892       NA Absence      640101
##  3 FR-173842 311       289.  79618924 79.61892       NA Absence      640101
##  4 FR-173792 311       235.  79618924 79.61892       NA Absence      640101
##  5 FR-173749 311       153.  79618924 79.61892       NA Absence      640101
##  6 FR-173715 311        83.7 79618924 79.61892       NA Absence      640101
##  7 FR-173687 311        26.9 79618924 79.61892       NA Absence      640101
##  8 FR-173686 311      2697.  79618924 79.61892       NA Absence      640101
##  9 FR-173667 311        49.2 79618924 79.61892       NA Absence      640101
## 10 FR-173664 311        52.6 79618924 79.61892       NA Absence      640101
## # … with 2,167 more rows, and 1 more variable: geometry &lt;GEOMETRY [m]&gt;
```

---

# Get forest area for each intersected `sfg`

```r
forest %&gt;% 
  st_crop(st_bbox(studysites)) %&gt;%
  st_intersection(studysites) %&gt;%
* mutate(area = st_area(.)) %&gt;%
  as_tibble()
```

```
## # A tibble: 2,177 x 9
##    ID        CODE_12 AREA_HA       area  areakm2 bigsites bearpresence idsite
##    &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;      [m^2]   [km^2]    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;
##  1 FR-173974 311       243.    640945.5 79.61892       NA Absence      640101
##  2 FR-173874 311     18041.   5354968.1 79.61892       NA Absence      640101
##  3 FR-173842 311       289.   2584901.8 79.61892       NA Absence      640101
##  4 FR-173792 311       235.    567599.1 79.61892       NA Absence      640101
##  5 FR-173749 311       153.   1530535.3 79.61892       NA Absence      640101
##  6 FR-173715 311        83.7   837290.0 79.61892       NA Absence      640101
##  7 FR-173687 311        26.9   268517.5 79.61892       NA Absence      640101
##  8 FR-173686 311      2697.  21933124.4 79.61892       NA Absence      640101
##  9 FR-173667 311        49.2   492324.9 79.61892       NA Absence      640101
## 10 FR-173664 311        52.6   526026.9 79.61892       NA Absence      640101
## # … with 2,167 more rows, and 1 more variable: geometry &lt;GEOMETRY [m]&gt;
```

---

# Sum forest over all study sites

```r
forestpyrenees &lt;- forest %&gt;% 
  st_crop(st_bbox(studysites)) %&gt;%
  st_intersection(studysites) %&gt;%
  mutate(area = st_area(.)) %&gt;%
* group_by(idsite) %&gt;% # groups a data frame by variables
* summarise(areaforest = sum(area)) %&gt;% # perform group-wise summaries
  as_tibble() %&gt;%
  select(-geometry)
forestpyrenees
```

```
## # A tibble: 138 x 2
##    idsite areaforest
##     &lt;dbl&gt;      [m^2]
##  1  11403  157762282
##  2  11404   32526319
##  3  90101  137218858
##  4  90102   86944708
##  5  90103   82872880
##  6  90104   42241267
##  7  90201   19224150
##  8  90202   26309123
##  9  90203   31962484
## 10  90301    8958589
## # … with 128 more rows
```

---

# Join `sf` and `tibble` objects 
## More info [here](https://r-spatial.github.io/sf/reference/tidyverse.html)

```r
studysites %&gt;% 
* inner_join(forestpyrenees, by = 'idsite')
```

```
## Simple feature collection with 138 features and 6 fields
## Geometry type: MULTIPOLYGON
## Dimension:     XY
## Bounding box:  xmin: 362039 ymin: 6139034 xmax: 690160.2 ymax: 6235505
## Projected CRS: RGF93_Lambert_93
## First 10 features:
##               area          areakm2 bigsites  bearpresence idsite
## 1   79618924 [m^2]  79.61892 [km^2]       NA       Absence 640101
## 2  122155210 [m^2] 122.15521 [km^2]       NA       Absence 640102
## 3   64012619 [m^2]  64.01262 [km^2]       NA Occasionnelle 640203
## 4   36208552 [m^2]  36.20855 [km^2]       NA Occasionnelle 640204
## 5   67904470 [m^2]  67.90447 [km^2]       NA       Absence 640202
## 6   58455872 [m^2]  58.45587 [km^2]       NA       Absence 640201
## 7   30310636 [m^2]  30.31064 [km^2]       NA       Absence 640301
## 8   25866722 [m^2]  25.86672 [km^2]       NA       Absence 640302
## 9   72321198 [m^2]  72.32120 [km^2]       NA Occasionnelle 640401
## 10  67797321 [m^2]  67.79732 [km^2]       NA     Reguliere 640402
##        areaforest                       geometry
## 1  42105194 [m^2] MULTIPOLYGON (((362110.5 62...
## 2  60136750 [m^2] MULTIPOLYGON (((372352.1 62...
## 3  26652318 [m^2] MULTIPOLYGON (((375125.4 62...
## 4  21003797 [m^2] MULTIPOLYGON (((384447.4 62...
## 5  42325894 [m^2] MULTIPOLYGON (((394521 6219...
## 6  22478565 [m^2] MULTIPOLYGON (((393646.7 62...
## 7  13955020 [m^2] MULTIPOLYGON (((396923.9 62...
## 8  19648844 [m^2] MULTIPOLYGON (((399383.2 62...
## 9  31347244 [m^2] MULTIPOLYGON (((399338.3 62...
## 10 21175525 [m^2] MULTIPOLYGON (((405268.8 62...
```

---

# Calculate forest cover

```r
covariates &lt;- studysites %&gt;% 
  inner_join(forestpyrenees, by = 'idsite') %&gt;% 
  mutate(.before = 1,
*        forestcover = areaforest / area)
```


---

# Map forest cover

```r
covariates %&gt;%
  ggplot() +
  aes(fill = as.numeric(forestcover)) +
  geom_sf(lwd = 0.1) +
  scale_fill_viridis_c(
    labels = scales::percent_format(), #&lt;&lt; format percentage
    name = 'Cover',
    alpha = 0.7) +  #&lt;&lt; control transparency
  labs(title = 'Map of forest cover in the Pyrenees mountains',
       subtitle = 'Source: Corine Land Cover 2012')
```

---

# Map forest cover
&lt;img src="index_files/figure-html/unnamed-chunk-31-1.png" style="display: block; margin: auto;" /&gt;

---

# Interactive map with `mapview`
## More info [here](https://r-spatial.github.io/mapview/)


```r
library(mapview)
*mapview(covariates, zcol = "bearpresence")
```

<div id="htmlwidget-922282909d8e859a7b7b" style="width:100%;height:360px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-922282909d8e859a7b7b">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron","CartoDB.Positron","CartoDB.Positron",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["CartoDB.DarkMatter","CartoDB.DarkMatter","CartoDB.DarkMatter",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenStreetMap","OpenStreetMap","OpenStreetMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["Esri.WorldImagery","Esri.WorldImagery","Esri.WorldImagery",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["polygon",420]},{"method":"addFlatGeoBuf","args":["covariates-bearpresence","covariates - bearpresence",null,true,"bearpresence",{"radius":6,"stroke":true,"color":"#333333","weight":0.5,"opacity":0.9,"fill":true,"fillColor":null,"fillOpacity":0.6},{"className":"","pane":"polygon"},"mapview-popup",{"radius":{"to":[3,15],"from":[3,15]},"weight":{"to":[1,10],"from":[1,10]},"opacity":{"to":[0,1],"from":[0,1]},"fillOpacity":{"to":[0,1],"from":[0,1]}}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-1.14405869775536,42.3467704628386,2.87957839532753,43.2015521327159,"covariates - bearpresence","Zoom to covariates - bearpresence","<strong> covariates - bearpresence <\/strong>","bottomright"]},{"method":"addLayersControl","args":[["CartoDB.Positron","CartoDB.DarkMatter","OpenStreetMap","Esri.WorldImagery","OpenTopoMap"],"covariates - bearpresence",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#4B0055","#009B95","#FDE333"],"labels":["Absence","Occasionnelle","Reguliere"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"factor","title":"covariates - bearpresence","extra":null,"layerId":null,"className":"info legend","group":"covariates - bearpresence"}]}],"fitBounds":[42.3467704628386,-1.14405869775536,43.2015521327159,2.87957839532753,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>

---

# Interactive map with `mapview`

```r
covariates &lt;- covariates %&gt;% mutate(forestcover = as.numeric(forestcover))
*mapview(covariates, zcol = "forestcover", map.types = "OpenTopoMap")
```

<div id="htmlwidget-d8777aa230d3462c61e0" style="width:100%;height:288px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-d8777aa230d3462c61e0">{"x":{"options":{"minZoom":1,"maxZoom":52,"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}},"preferCanvas":false,"bounceAtZoomLimits":false,"maxBounds":[[[-90,-370]],[[90,370]]]},"calls":[{"method":"addProviderTiles","args":["OpenTopoMap","OpenTopoMap","OpenTopoMap",{"errorTileUrl":"","noWrap":false,"detectRetina":false,"pane":"tilePane"}]},{"method":"createMapPane","args":["polygon",420]},{"method":"addFlatGeoBuf","args":["covariates-forestcover","covariates - forestcover",null,true,"forestcover",{"radius":6,"stroke":true,"color":"#333333","weight":0.5,"opacity":0.9,"fill":true,"fillColor":null,"fillOpacity":0.6},{"className":"","pane":"polygon"},"mapview-popup",{"radius":{"to":[3,15],"from":[3,15]},"weight":{"to":[1,10],"from":[1,10]},"opacity":{"to":[0,1],"from":[0,1]},"fillOpacity":{"to":[0,1],"from":[0,1]}}]},{"method":"addScaleBar","args":[{"maxWidth":100,"metric":true,"imperial":true,"updateWhenIdle":true,"position":"bottomleft"}]},{"method":"addHomeButton","args":[-1.14405869775536,42.3467704628386,2.87957839532753,43.2015521327159,"covariates - forestcover","Zoom to covariates - forestcover","<strong> covariates - forestcover <\/strong>","bottomright"]},{"method":"addLayersControl","args":["OpenTopoMap","covariates - forestcover",{"collapsed":true,"autoZIndex":true,"position":"topleft"}]},{"method":"addLegend","args":[{"colors":["#4B0055 , #471E67 7.39363195257352%, #2A4782 19.4335204686624%, #006A93 31.4734089847513%, #008B98 43.5132975008402%, #00A890 55.5531860169291%, #00C07B 67.593074533018%, #7BD358 79.6329630491069%, #CDE030 91.6728515651958%, #FDE333 "],"labels":["0.1","0.2","0.3","0.4","0.5","0.6","0.7","0.8"],"na_color":null,"na_label":"NA","opacity":1,"position":"topright","type":"numeric","title":"covariates - forestcover","extra":{"p_1":0.0739363195257352,"p_n":0.916728515651958},"layerId":null,"className":"info legend","group":"covariates - forestcover"}]}],"fitBounds":[42.3467704628386,-1.14405869775536,43.2015521327159,2.87957839532753,[]]},"evals":[],"jsHooks":{"render":[{"code":"function(el, x, data) {\n  return (\n      function(el, x, data) {\n      // get the leaflet map\n      var map = this; //HTMLWidgets.find('#' + el.id);\n      // we need a new div element because we have to handle\n      // the mouseover output separately\n      // debugger;\n      function addElement () {\n      // generate new div Element\n      var newDiv = $(document.createElement('div'));\n      // append at end of leaflet htmlwidget container\n      $(el).append(newDiv);\n      //provide ID and style\n      newDiv.addClass('lnlt');\n      newDiv.css({\n      'position': 'relative',\n      'bottomleft':  '0px',\n      'background-color': 'rgba(255, 255, 255, 0.7)',\n      'box-shadow': '0 0 2px #bbb',\n      'background-clip': 'padding-box',\n      'margin': '0',\n      'padding-left': '5px',\n      'color': '#333',\n      'font': '9px/1.5 \"Helvetica Neue\", Arial, Helvetica, sans-serif',\n      'z-index': '700',\n      });\n      return newDiv;\n      }\n\n\n      // check for already existing lnlt class to not duplicate\n      var lnlt = $(el).find('.lnlt');\n\n      if(!lnlt.length) {\n      lnlt = addElement();\n\n      // grab the special div we generated in the beginning\n      // and put the mousmove output there\n\n      map.on('mousemove', function (e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                           ' lon: ' + (e.latlng.lng).toFixed(5) +\n                           ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                           ' | zoom: ' + map.getZoom() +\n                           ' | x: ' + L.CRS.EPSG3857.project(e.latlng).x.toFixed(0) +\n                           ' | y: ' + L.CRS.EPSG3857.project(e.latlng).y.toFixed(0) +\n                           ' | epsg: 3857 ' +\n                           ' | proj4: +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs ');\n      } else {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      }\n      });\n\n      // remove the lnlt div when mouse leaves map\n      map.on('mouseout', function (e) {\n      var strip = document.querySelector('.lnlt');\n      if( strip !==null) strip.remove();\n      });\n\n      };\n\n      //$(el).keypress(67, function(e) {\n      map.on('preclick', function(e) {\n      if (e.originalEvent.ctrlKey) {\n      if (document.querySelector('.lnlt') === null) lnlt = addElement();\n      lnlt.text(\n                      ' lon: ' + (e.latlng.lng).toFixed(5) +\n                      ' | lat: ' + (e.latlng.lat).toFixed(5) +\n                      ' | zoom: ' + map.getZoom() + ' ');\n      var txt = document.querySelector('.lnlt').textContent;\n      console.log(txt);\n      //txt.innerText.focus();\n      //txt.select();\n      setClipboardText('\"' + txt + '\"');\n      }\n      });\n\n      }\n      ).call(this.getMap(), el, x, data);\n}","data":null},{"code":"function(el, x, data) {\n  return (function(el,x,data){\n           var map = this;\n\n           map.on('keypress', function(e) {\n               console.log(e.originalEvent.code);\n               var key = e.originalEvent.code;\n               if (key === 'KeyE') {\n                   var bb = this.getBounds();\n                   var txt = JSON.stringify(bb);\n                   console.log(txt);\n\n                   setClipboardText('\\'' + txt + '\\'');\n               }\n           })\n        }).call(this.getMap(), el, x, data);\n}","data":null}]}}</script>

```r
# map.types = "CartoDB.Positron", "CartoDB.DarkMatter", "OpenStreetMap", 
# "Esri.WorldImagery"
```


---

# Human density

* Human density might be a driver of brown bear distribution

* We use data on population size of cities in France

* Population data is available from **IGN Admin-Express** database   [here](https://geoservices.ign.fr/documentation/diffusion/telechargement-donnees-libres.html#admin-express)  

---

# Human density


```r
load("shp/france_population_data_2016.RData")
glimpse(df.france)
```

```
## Rows: 35,798
## Columns: 18
## $ ID_GEOFLA  &lt;fct&gt; COMMUNE00000000000000001, COMMUNE00000000000000002, COMMUNE…
## $ CODE_COM   &lt;fct&gt; 216, 033, 009, 225, 890, 018, 113, 319, 097, 070, 046, 524,…
## $ INSEE_COM  &lt;fct&gt; 32216, 47033, 32009, 38225, 62890, 08018, 32113, 10319, 060…
## $ NOM_COM    &lt;fct&gt; LOURTIES-MONBRUN, BOUDY-DE-BEAUREGARD, ARMOUS-ET-CAU, AUTRA…
## $ STATUT     &lt;fct&gt; Commune simple, Commune simple, Commune simple, Commune sim…
## $ X_CHF_LIEU &lt;int&gt; 500820, 516424, 472979, 898640, 640049, 824246, 461332, 746…
## $ Y_CHF_LIEU &lt;int&gt; 6264958, 6384852, 6278963, 6450689, 7028672, 6908952, 63007…
## $ X_CENTROID &lt;int&gt; 500515, 515575, 473004, 898625, 640115, 824391, 460721, 747…
## $ Y_CENTROID &lt;int&gt; 6265413, 6385938, 6278937, 6451597, 7029900, 6908954, 63022…
## $ Z_MOYEN    &lt;int&gt; 252, 112, 221, 1234, 79, 125, 134, 167, 752, 438, 1276, 362…
## $ SUPERFICIE &lt;dbl&gt; 966, 1019, 932, 3371, 1023, 438, 919, 1904, 2217, 2667, 306…
## $ POPULATION &lt;dbl&gt; 139, 414, 95, 2973, 178, 80, 97, 362, 296, 901, 10, 166, 94…
## $ CODE_ARR   &lt;fct&gt; 3, 3, 3, 1, 4, 4, 2, 3, 2, 2, 2, 3, 2, 1, 1, 3, 2, 1, 3, 3,…
## $ CODE_DEPT  &lt;fct&gt; 32, 47, 32, 38, 62, 08, 32, 10, 06, 42, 31, 71, 53, 16, 38,…
## $ NOM_DEPT   &lt;fct&gt; GERS, LOT-ET-GARONNE, GERS, ISERE, PAS-DE-CALAIS, ARDENNES,…
## $ CODE_REG   &lt;fct&gt; 76, 75, 76, 84, 32, 44, 76, 44, 93, 84, 76, 27, 52, 75, 84,…
## $ NOM_REG    &lt;fct&gt; LANGUEDOC-ROUSSILLON-MIDI-PYRENEES, AQUITAINE-LIMOUSIN-POIT…
## $ geometry   &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((499484.6 62..., MULTIPOLYGON (…
```

---

# Transform into lower case

```r
colnames(df.france) &lt;- colnames(df.france) %&gt;% 
* str_to_lower()
colnames(df.france)
```

```
##  [1] "id_geofla"  "code_com"   "insee_com"  "nom_com"    "statut"    
##  [6] "x_chf_lieu" "y_chf_lieu" "x_centroid" "y_centroid" "z_moyen"   
## [11] "superficie" "population" "code_arr"   "code_dept"  "nom_dept"  
## [16] "code_reg"   "nom_reg"    "geometry"
```

---

# Have a look to the distribution

```r
df.france$population %&gt;% 
* summary()
```

```
##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##       0     197     442    1779    1100  458298
```

---

# Calculate density

```r
df.france &lt;- df.france %&gt;% 
* mutate(density = population/superficie*100)
as_tibble(df.france)
```

```
## # A tibble: 35,798 x 19
##    id_geofla  code_com insee_com nom_com statut x_chf_lieu y_chf_lieu x_centroid
##    &lt;fct&gt;      &lt;fct&gt;    &lt;fct&gt;     &lt;fct&gt;   &lt;fct&gt;       &lt;int&gt;      &lt;int&gt;      &lt;int&gt;
##  1 COMMUNE00… 216      32216     LOURTI… Commu…     500820    6264958     500515
##  2 COMMUNE00… 033      47033     BOUDY-… Commu…     516424    6384852     515575
##  3 COMMUNE00… 009      32009     ARMOUS… Commu…     472979    6278963     473004
##  4 COMMUNE00… 225      38225     AUTRAN… Commu…     898640    6450689     898625
##  5 COMMUNE00… 890      62890     WILLEM… Commu…     640049    7028672     640115
##  6 COMMUNE00… 018      08018     ARDEUI… Commu…     824246    6908952     824391
##  7 COMMUNE00… 113      32113     CRAVEN… Commu…     461332    6300782     460721
##  8 COMMUNE00… 319      10319     RIGNY-… Commu…     746925    6790005     747181
##  9 COMMUNE00… 097      06097     PIERRE… Commu…    1028827    6315717    1027327
## 10 COMMUNE00… 070      42070     CORDEL… Commu…     782215    6538794     782159
## # … with 35,788 more rows, and 11 more variables: y_centroid &lt;int&gt;,
## #   z_moyen &lt;int&gt;, superficie &lt;dbl&gt;, population &lt;dbl&gt;, code_arr &lt;fct&gt;,
## #   code_dept &lt;fct&gt;, nom_dept &lt;fct&gt;, code_reg &lt;fct&gt;, nom_reg &lt;fct&gt;,
## #   geometry &lt;MULTIPOLYGON [m]&gt;, density &lt;dbl&gt;
```

---

# Show density

```r
df.france %&gt;%
  pull(density) %&gt;%
  head()
```

```
## [1] 14.38923 40.62807 10.19313 88.19341 17.39980 18.26484
```

---

# Sum population size over sites

```r
df.pyrenees &lt;- df.france %&gt;% 
  st_transform(crs = st_crs(forest)) %&gt;%
  st_crop(st_bbox(covariates)) %&gt;%
  st_intersection(covariates) %&gt;%
  st_set_geometry(NULL) %&gt;%
* group_by(idsite) %&gt;%
* summarise(humpop = sum(population))
df.pyrenees
```

```
## # A tibble: 138 x 2
##    idsite humpop
##     &lt;dbl&gt;  &lt;dbl&gt;
##  1  11403  10711
##  2  11404   7576
##  3  90101  33154
##  4  90102  17391
##  5  90103  19126
##  6  90104  28000
##  7  90201   8203
##  8  90202   2554
##  9  90203   3505
## 10  90301    285
## # … with 128 more rows
```

---

# Join, then calculate density

```r
covariates &lt;- covariates %&gt;% 
* inner_join(df.pyrenees, by = 'idsite') %&gt;%
  mutate(.before = 1,
*        humdens = humpop / (area/1000000))
as_tibble(covariates)
```

```
## # A tibble: 138 x 10
##     humdens forestcover      area   areakm2 bigsites bearpresence  idsite
##     [1/m^2]       &lt;dbl&gt;     [m^2]    [km^2]    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;
##  1 15.73746       0.529  79618924  79.61892       NA Absence       640101
##  2 16.38080       0.492 122155210 122.15521       NA Absence       640102
##  3 10.01365       0.416  64012619  64.01262       NA Occasionnelle 640203
##  4 51.83858       0.580  36208552  36.20855       NA Occasionnelle 640204
##  5 30.42510       0.623  67904470  67.90447       NA Absence       640202
##  6 68.13687       0.385  58455872  58.45587       NA Absence       640201
##  7 58.79124       0.460  30310636  30.31064       NA Absence       640301
##  8 70.63129       0.760  25866722  25.86672       NA Absence       640302
##  9 39.78087       0.433  72321198  72.32120       NA Occasionnelle 640401
## 10 12.74387       0.312  67797321  67.79732       NA Reguliere     640402
## # … with 128 more rows, and 3 more variables: areaforest [m^2], humpop &lt;dbl&gt;,
## #   geometry &lt;MULTIPOLYGON [m]&gt;
```

---

# Map human population density

```r
covariates %&gt;%
  ggplot() +
  aes(fill = as.numeric(humdens)) +
  geom_sf(lwd = 0.1) +
  scale_fill_viridis_c(
    name = bquote('Density\n(people per km'^2*')'),
    alpha = 0.7) + 
  labs(title = 'Human population density',
       subtitle = 'Source: IGN GEOFLA 2016')
```

---

# Map human population density
&lt;img src="index_files/figure-html/unnamed-chunk-42-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse, middle, center
# Spatial operations: distance
---


# Distance to highways

* Distance to highways might be a driver of brown bear distribution

* We use data from [Route500 database](https://geoservices.ign.fr/documentation/diffusion/telechargement-donnees-libres.html#route-500)

---

# Read in data

```r
roads &lt;- st_read("shp/TRONCON_ROUTE.shp")
```

```
## Reading layer `TRONCON_ROUTE' from data source `/Users/loulou/Travail/R/intro_spatialR/shp/TRONCON_ROUTE.shp' using driver `ESRI Shapefile'
## Simple feature collection with 339250 features and 12 fields
## Geometry type: LINESTRING
## Dimension:     XY
## Bounding box:  xmin: 100076.5 ymin: 6021027 xmax: 1329738 ymax: 7120638
## Projected CRS: RGF93_Lambert_93
```

---

# Read in data

```r
as_tibble(roads)
```

```
## # A tibble: 339,250 x 13
##    ID_RTE500 VOCATION  NB_CHAUSSE NB_VOIES ETAT  ACCES RES_VERT SENS  RES_EUROPE
##        &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;     
##  1         1 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
##  2         2 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
##  3         3 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
##  4         4 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
##  5         5 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
##  6         6 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
##  7         7 "Liaison… "1 chauss… "2 voie… "Rev… Libre N'appar… Sens… &lt;NA&gt;      
##  8         8 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
##  9         9 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
## 10        10 "Liaison… "1 chauss… "1 voie… "Rev… Libre N'appar… Doub… &lt;NA&gt;      
## # … with 339,240 more rows, and 4 more variables: NUM_ROUTE &lt;chr&gt;,
## #   CLASS_ADM &lt;chr&gt;, LONGUEUR &lt;dbl&gt;, geometry &lt;LINESTRING [m]&gt;
```

---

# Focus on highways

```r
highways &lt;- roads %&gt;%
* filter(CLASS_ADM == "Autoroute")
as_tibble(highways)
```

```
## # A tibble: 4,506 x 13
##    ID_RTE500 VOCATION  NB_CHAUSSE NB_VOIES ETAT  ACCES RES_VERT SENS  RES_EUROPE
##        &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;     
##  1        32 Type aut… "2 chauss… "Sans o… "Rev… "A p… Apparti… Doub… &lt;NA&gt;      
##  2        33 Type aut… "1 chauss… "2 voie… "Rev… "A p… Apparti… Doub… &lt;NA&gt;      
##  3      1041 Type aut… "1 chauss… "1 voie… "Rev… "Lib… Apparti… Sens… &lt;NA&gt;      
##  4      2460 Type aut… "2 chauss… "Sans o… "Rev… "Lib… N'appar… Doub… E60       
##  5      3074 Type aut… "1 chauss… "1 voie… "Rev… "Lib… N'appar… Sens… &lt;NA&gt;      
##  6      3198 Type aut… "1 chauss… "1 voie… "Rev… "A p… Apparti… Sens… E712      
##  7      3200 Type aut… "2 chauss… "Sans o… "Rev… "Lib… Apparti… Doub… &lt;NA&gt;      
##  8      3201 Type aut… "2 chauss… "Sans o… "Rev… "Lib… Apparti… Doub… &lt;NA&gt;      
##  9      3202 Type aut… "2 chauss… "Sans o… "Rev… "Lib… Apparti… Doub… &lt;NA&gt;      
## 10      3363 Type aut… "2 chauss… "Sans o… "Rev… "A p… Apparti… Doub… E713      
## # … with 4,496 more rows, and 4 more variables: NUM_ROUTE &lt;chr&gt;,
## #   CLASS_ADM &lt;chr&gt;, LONGUEUR &lt;dbl&gt;, geometry &lt;LINESTRING [m]&gt;
```

---

# Reproject and crop to match France extent

```r
highways &lt;- highways %&gt;% 
* st_transform(crs = st_crs(forest)) %&gt;%
* st_crop(st_bbox(df.france))
as_tibble(highways)
```

```
## # A tibble: 4,494 x 13
##    ID_RTE500 VOCATION  NB_CHAUSSE NB_VOIES ETAT  ACCES RES_VERT SENS  RES_EUROPE
##        &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;     
##  1        32 Type aut… "2 chauss… "Sans o… "Rev… "A p… Apparti… Doub… &lt;NA&gt;      
##  2        33 Type aut… "1 chauss… "2 voie… "Rev… "A p… Apparti… Doub… &lt;NA&gt;      
##  3      1041 Type aut… "1 chauss… "1 voie… "Rev… "Lib… Apparti… Sens… &lt;NA&gt;      
##  4      2460 Type aut… "2 chauss… "Sans o… "Rev… "Lib… N'appar… Doub… E60       
##  5      3074 Type aut… "1 chauss… "1 voie… "Rev… "Lib… N'appar… Sens… &lt;NA&gt;      
##  6      3198 Type aut… "1 chauss… "1 voie… "Rev… "A p… Apparti… Sens… E712      
##  7      3200 Type aut… "2 chauss… "Sans o… "Rev… "Lib… Apparti… Doub… &lt;NA&gt;      
##  8      3201 Type aut… "2 chauss… "Sans o… "Rev… "Lib… Apparti… Doub… &lt;NA&gt;      
##  9      3202 Type aut… "2 chauss… "Sans o… "Rev… "Lib… Apparti… Doub… &lt;NA&gt;      
## 10      3363 Type aut… "2 chauss… "Sans o… "Rev… "A p… Apparti… Doub… E713      
## # … with 4,484 more rows, and 4 more variables: NUM_ROUTE &lt;chr&gt;,
## #   CLASS_ADM &lt;chr&gt;, LONGUEUR &lt;dbl&gt;, geometry &lt;LINESTRING [m]&gt;
```

---

# Get centroids of each monitoring sites

```r
centroids &lt;- covariates %&gt;% 
* st_centroid()
as_tibble(centroids)
```

```
## # A tibble: 138 x 10
##     humdens forestcover      area   areakm2 bigsites bearpresence  idsite
##     [1/m^2]       &lt;dbl&gt;     [m^2]    [km^2]    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;
##  1 15.73746       0.529  79618924  79.61892       NA Absence       640101
##  2 16.38080       0.492 122155210 122.15521       NA Absence       640102
##  3 10.01365       0.416  64012619  64.01262       NA Occasionnelle 640203
##  4 51.83858       0.580  36208552  36.20855       NA Occasionnelle 640204
##  5 30.42510       0.623  67904470  67.90447       NA Absence       640202
##  6 68.13687       0.385  58455872  58.45587       NA Absence       640201
##  7 58.79124       0.460  30310636  30.31064       NA Absence       640301
##  8 70.63129       0.760  25866722  25.86672       NA Absence       640302
##  9 39.78087       0.433  72321198  72.32120       NA Occasionnelle 640401
## 10 12.74387       0.312  67797321  67.79732       NA Reguliere     640402
## # … with 128 more rows, and 3 more variables: areaforest [m^2], humpop &lt;dbl&gt;,
## #   geometry &lt;POINT [m]&gt;
```

---

# Then distance from centroids to highways

```r
dtohighways &lt;- highways %&gt;% 
* st_distance(centroids, by_element = F)
head(dtohighways)
```

```
## Units: [m]
##          [,1]     [,2]     [,3]     [,4]     [,5]     [,6]     [,7]     [,8]
## [1,] 490490.3 488265.3 493003.4 492821.9 487237.4 481060.4 481121.5 486089.2
## [2,] 515331.5 507719.9 508080.6 503082.1 499732.8 494803.3 490230.3 494329.4
## [3,] 718550.3 716685.9 721602.9 721642.1 716013.6 709840.7 710080.5 715040.7
## [4,] 898734.7 890836.7 890814.1 885459.0 882398.2 877681.9 872780.4 876701.3
## [5,] 919059.7 915277.9 918978.3 917377.9 912208.2 906119.3 904794.9 909730.3
## [6,] 679572.2 671341.9 670914.4 665250.8 662457.8 657966.6 652762.1 656514.7
##          [,9]    [,10]    [,11]    [,12]    [,13]    [,14]    [,15]    [,16]
## [1,] 492001.5 498394.1 486791.1 480913.1 477857.5 486211.6 494968.5 502324.0
## [2,] 496296.6 499690.1 490796.0 486687.6 480646.9 485431.1 491383.7 498446.8
## [3,] 721040.1 727480.1 715870.2 709978.7 707015.7 715405.3 724179.1 731511.8
## [4,] 878203.4 881160.3 872809.8 868989.3 862787.5 867045.2 872482.5 879296.8
## [5,] 914698.5 920441.5 909152.7 903547.5 899397.6 907014.2 915278.5 922884.7
## [6,] 657646.3 660295.5 652347.9 648767.0 642453.8 646315.8 651414.2 658068.7
##         [,17]    [,18]    [,19]    [,20]    [,21]    [,22]    [,23]    [,24]
## [1,] 503492.4 496943.5 485118.6 475420.8 476127.3 483837.8 489587.5 497561.7
## [2,] 496659.6 489140.4 480224.3 474727.6 468192.9 475111.9 478057.0 484235.5
## [3,] 732726.8 726207.8 714378.6 704653.7 705421.4 713128.9 718882.7 726857.0
## [4,] 877162.5 869748.3 861490.3 856646.4 849448.8 856046.2 858513.1 864218.4
## [5,] 923129.9 915942.4 904508.9 895707.7 894016.9 901863.1 906940.6 914692.3
## [6,] 655757.1 648417.1 640554.2 636163.0 628543.0 634931.2 637135.9 642599.0
##         [,25]    [,26]    [,27]    [,28]    [,29]    [,30]    [,31]    [,32]
## [1,] 502169.7 481567.1 494352.4 474992.7 481480.9 491781.3 499425.2 499168.0
## [2,] 490669.7 469656.0 476853.7 461019.4 463382.6 471086.6 476109.0 472448.7
## [3,] 731455.3 710861.2 723633.3 704268.0 710728.3 721024.2 728653.8 728335.1
## [4,] 870699.8 850345.0 856472.2 841725.9 843418.0 850425.0 854812.8 850718.4
## [5,] 920160.9 898366.7 909839.9 890702.8 896063.3 905972.7 913051.2 911505.9
## [6,] 649084.4 629112.4 634714.8 620529.0 621881.8 628569.4 632707.6 628477.0
##         [,33]    [,34]    [,35]    [,36]    [,37]    [,38]    [,39]    [,40]
## [1,] 473359.6 479866.0 497112.3 507856.6 507231.0 494691.9 488694.2 483485.9
## [2,] 454703.7 453431.2 467322.2 476102.5 470137.5 459471.4 458986.0 448385.6
## [3,] 702571.7 708940.2 726197.0 736947.8 736155.7 723591.0 717731.1 712297.4
## [4,] 834985.8 832571.6 845269.9 853278.5 846545.5 836778.2 837326.5 826258.2
## [5,] 887280.1 891245.8 908168.2 918722.5 915966.5 903490.5 899318.1 891690.5
## [6,] 613592.4 610688.8 622940.8 630709.8 623801.3 614284.5 615143.6 603956.2
##         [,41]    [,42]    [,43]    [,44]    [,45]    [,46]    [,47]    [,48]
## [1,] 472425.6 474027.4 488915.6 498881.3 506604.3 502202.7 506817.8 491798.5
## [2,] 444035.2 433861.1 445765.1 455722.7 459705.6 450874.4 450573.0 439475.0
## [3,] 701390.0 702510.7 717416.6 727485.9 735103.1 730408.3 734823.0 719836.0
## [4,] 823267.2 811533.3 822217.3 831629.6 834577.6 825257.8 823794.0 814319.2
## [5,] 882612.4 879602.2 894162.6 904699.2 911295.2 904767.3 907540.2 893345.5
## [6,] 601448.0 589212.0 599540.7 608806.6 611544.2 602158.7 600523.1 591323.7
##         [,49]    [,50]    [,51]    [,52]    [,53]    [,54]    [,55]    [,56]
## [1,] 475689.4 486361.4 496396.0 505461.2 508708.4 502688.9 500488.5 490572.9
## [2,] 424506.8 429328.2 438305.6 446520.2 444575.9 440943.0 435418.2 425741.0
## [3,] 703638.9 714160.8 724241.6 733348.4 736385.9 730425.2 728033.4 718018.8
## [4,] 800498.9 803698.2 811844.1 819315.0 816130.5 813379.1 807353.6 798415.8
## [5,] 876778.2 885620.4 895773.9 904969.2 906144.8 900841.1 897066.2 886693.2
## [6,] 577771.0 580642.5 588639.9 595996.4 592678.6 590026.9 583954.6 575119.6
##         [,57]    [,58]    [,59]    [,60]    [,61]    [,62]    [,63]    [,64]
## [1,] 491709.5 492957.5 487799.3 485401.4 483950.1 481832.5 476828.7 471875.6
## [2,] 430317.6 422020.5 416952.2 420583.3 415038.0 416914.8 414854.3 409226.4
## [3,] 719353.2 720058.9 714835.3 712785.3 711060.6 709165.2 704269.5 699212.6
## [4,] 803557.0 793332.5 788670.2 793623.5 787416.5 790187.9 788996.4 783592.1
## [5,] 889402.5 886479.0 881057.7 881223.8 877854.7 877396.4 873383.9 867825.1
## [6,] 580326.3 569891.7 565279.4 570385.1 564104.3 566989.5 565935.9 560582.9
##         [,65]    [,66]    [,67]    [,68]    [,69]    [,70]    [,71]    [,72]
## [1,] 471133.2 478433.0 467224.9 478267.6 483336.1 488707.0 495988.4 496239.6
## [2,] 399364.7 406573.1 385972.3 398082.5 404211.6 411855.8 418506.7 416067.2
## [3,] 697846.1 705258.1 693080.8 704433.1 709681.5 715323.2 722670.3 722716.4
## [4,] 772177.6 778808.1 757321.8 768701.7 774622.2 782294.5 788225.0 785182.4
## [5,] 862932.5 870655.9 854311.5 866587.7 872478.1 879247.4 886663.8 885660.5
## [6,] 548953.8 555495.4 533950.7 545236.0 551128.2 558791.0 564657.4 561578.9
##         [,73]    [,74]    [,75]    [,76]    [,77]    [,78]    [,79]    [,80]
## [1,] 497351.8 498488.9 494125.2 490926.0 488453.9 484933.1 491710.4 499237.4
## [2,] 415251.3 413444.7 408765.0 410831.2 403627.3 397313.1 401986.7 409372.4
## [3,] 723690.0 724597.3 720129.6 717321.9 714402.8 710555.6 717264.9 724922.2
## [4,] 783847.1 781276.5 776908.1 780406.1 772389.3 765776.1 769352.1 776009.4
## [5,] 885918.3 885703.2 880930.2 880069.9 875177.3 870075.6 876229.6 884132.2
## [6,] 560215.4 557610.7 553260.5 556838.6 548779.6 542157.1 545677.5 552306.1
##         [,81]    [,82]    [,83]    [,84]    [,85]    [,86]    [,87]    [,88]
## [1,] 505515.8 505438.5 470916.3 483643.9 489460.8 496111.3 497431.5 507472.6
## [2,] 412933.8 410735.6 379468.7 391089.7 392533.5 398195.4 394546.3 405002.5
## [3,] 731056.5 730767.8 695849.1 708748.2 714227.7 720915.4 721706.2 732013.8
## [4,] 778323.6 775599.8 748415.3 758568.2 758416.7 763168.7 758117.5 767632.3
## [5,] 889416.7 888267.0 853254.0 866253.9 870215.7 876761.0 875580.2 886418.1
## [6,] 554595.6 551867.9 524849.4 534908.1 534704.6 539440.1 534385.1 543912.1
##         [,89]    [,90]    [,91]    [,92]    [,93]    [,94]    [,95]    [,96]
## [1,] 506054.1 498338.2 514893.4 514576.8 506721.1 504218.2 499282.7 494772.2
## [2,] 408174.2 402349.1 408192.4 404061.2 400625.9 395190.2 389825.2 383362.2
## [3,] 731067.6 723394.5 739103.6 738316.2 730825.8 727907.2 722800.1 717925.1
## [4,] 772163.4 767580.9 768863.5 763662.3 762345.9 756370.3 751438.7 744954.9
## [5,] 887298.6 880104.5 892013.9 889628.9 883711.4 879496.8 874044.2 868209.0
## [6,] 548430.8 543853.9 545195.0 540029.9 538641.2 532675.0 527729.5 521242.2
##         [,97]    [,98]    [,99]   [,100]   [,101]   [,102]   [,103]   [,104]
## [1,] 488371.7 483855.2 477691.3 473978.4 496337.7 502441.2 514891.1 506367.4
## [2,] 380227.6 383135.3 375615.0 366123.3 378882.7 385990.2 398476.6 384521.1
## [3,] 711784.3 708064.8 701585.2 697041.1 718709.0 725112.1 737873.3 728376.7
## [4,] 743419.4 748678.0 741485.8 731017.7 738598.1 745257.4 756274.6 741689.9
## [5,] 863182.6 862304.7 855037.0 848019.0 866538.8 873557.1 886721.0 874673.9
## [6,] 519686.9 524963.7 517783.8 507299.9 514931.7 521615.8 532720.0 518144.1
##        [,105]   [,106]   [,107]   [,108]   [,109]   [,110]   [,111]   [,112]
## [1,] 519938.4 527220.8 522444.3 524730.6 514998.4 520210.1 527786.4 501791.0
## [2,] 396238.3 397922.8 392269.6 392259.2 385965.6 387611.9 393333.5 376421.7
## [3,] 742023.7 748650.8 743618.1 745601.8 736155.1 740942.5 748418.5 723151.7
## [4,] 751115.8 749975.1 744645.4 743526.2 739716.4 739446.5 743476.2 733090.0
## [5,] 887920.4 892321.2 886786.9 887826.3 879625.6 883000.9 889846.9 867821.5
## [6,] 527740.9 526833.3 521456.6 520435.4 516397.1 516288.6 520495.6 509555.7
##        [,113]   [,114]   [,115]   [,116]   [,117]   [,118]   [,119]   [,120]
## [1,] 508003.7 503868.6 512530.8 514341.4 522197.3 530088.4 522084.0 520447.0
## [2,] 375353.1 366072.6 370142.3 377286.7 383421.2 390751.5 377493.1 371014.0
## [3,] 728391.5 723270.9 731387.1 734178.2 741961.6 749970.3 740824.1 738243.0
## [4,] 728845.6 718422.2 719594.6 728378.6 732770.5 738765.7 724686.5 716589.1
## [5,] 870117.3 862663.5 868972.2 874148.3 881356.7 889290.0 877634.2 872848.8
## [6,] 505514.4 495148.4 496584.7 505248.5 509827.1 515991.7 501936.7 493981.3
##        [,121]   [,122]   [,123]   [,124]   [,125]   [,126]   [,127]   [,128]
## [1,] 507456.2 509163.1 522078.4 530625.7 535061.9 537928.8 547655.2 557358.3
## [2,] 358845.6 353092.4 365308.8 373897.1 383797.5 392367.0 392536.2 395338.5
## [3,] 725007.3 725300.9 738486.1 747299.3 752931.8 756931.1 765125.9 773698.3
## [4,] 706803.2 697915.2 707659.5 714839.0 726331.8 736807.8 731423.8 729457.2
## [5,] 859728.1 856708.0 869786.9 878749.8 886964.6 893612.4 897572.2 903008.2
## [6,] 483884.3 475287.0 485393.2 492809.0 504163.3 514452.4 509808.9 508586.0
##        [,129]   [,130]   [,131]   [,132]   [,133]   [,134]   [,135]   [,136]
## [1,] 545520.1 549730.6 552381.4 540689.9 538668.6 535793.2 539028.1 488084.1
## [2,] 382045.9 401708.2 411238.4 401014.0 404229.0 404722.4 411295.1 464599.6
## [3,] 761232.2 768594.2 772517.5 760787.7 759575.9 757160.1 760976.0 717268.7
## [4,] 717458.2 743375.1 755404.9 747401.3 752903.2 755022.9 762386.6 843750.4
## [5,] 889718.5 904360.1 911474.6 900177.5 901258.3 900263.7 905621.5 901042.0
## [6,] 496270.1 521435.2 533189.9 524858.7 530118.4 532071.1 539380.9 621839.7
##        [,137]   [,138]
## [1,] 511083.6 498086.9
## [2,] 341971.2 326549.7
## [3,] 724481.3 710457.4
## [4,] 681047.7 667126.5
## [5,] 849928.1 834630.9
## [6,] 459013.4 444788.6
```

---

# Convert distance to highways into numeric values and keep only minimal distance to highways

```r
units(dtohighways) &lt;- units::as_units("km")
dtohighwaysnum &lt;- matrix(as.numeric(dtohighways),
                      nrow = nrow(dtohighways),
                      ncol = ncol(dtohighways))
dtohighwaysnum &lt;- apply(dtohighwaysnum,2,min)
head(dtohighwaysnum)
```

```
## [1] 48.67387 49.63361 53.25704 50.65845 45.78141 39.89380
```

---

# Map the distance to highways

```r
covariates &lt;- covariates %&gt;%
  add_column(dtohighwaysnum)
covariates %&gt;%
  ggplot() +
  geom_sf(lwd = 0.1, aes(fill = dtohighwaysnum)) +
  scale_fill_viridis_c(name = 'distance\n(km)',alpha = 0.7) + 
  geom_sf(data = highways, aes(color = 'red'), show.legend = "line") +
  scale_color_manual(values = "red", labels = "", name = "highway") +
  coord_sf(xlim = st_bbox(covariates)[c(1,3)], 
           ylim = st_bbox(covariates)[c(2,4)]) + # what if you turn this off?
  labs(title = 'Distance to highways in the Pyrénées', 
       subtitle = 'Source: Route500')
```

---

# Map the distance to highways
&lt;img src="index_files/figure-html/unnamed-chunk-51-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse, middle, center
# Bonus 2021
---

# HOW TO : Generate geometries from X, Y columns

* We're using [EPSG code = 4326](https://epsg.io/4326) as CRS, for WGS84 coordinates 


```r
random_pts &lt;- tibble(
  id_point = seq_len(10),
  lat=c(42.96, 42.71, 42.72, 42.95, 42.96, 42.72, 42.68, 42.82, 42.79, 42.85),
  lon=c(0.31, 0.66, 0.75, 1.60, 0.58, 1.87, 1.07, 1.05, 0.36, 0.06)
)
*sf_pts &lt;- st_as_sf(
* random_pts, coords = c("lon", "lat"), crs=4326, remove=FALSE)
sf_pts
```

```
## Simple feature collection with 10 features and 3 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 0.06 ymin: 42.68 xmax: 1.87 ymax: 42.96
## Geodetic CRS:  WGS 84
## # A tibble: 10 x 4
##    id_point   lat   lon     geometry
##  *    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;POINT [°]&gt;
##  1        1  43.0  0.31 (0.31 42.96)
##  2        2  42.7  0.66 (0.66 42.71)
##  3        3  42.7  0.75 (0.75 42.72)
##  4        4  43.0  1.6   (1.6 42.95)
##  5        5  43.0  0.58 (0.58 42.96)
##  6        6  42.7  1.87 (1.87 42.72)
##  7        7  42.7  1.07 (1.07 42.68)
##  8        8  42.8  1.05 (1.05 42.82)
##  9        9  42.8  0.36 (0.36 42.79)
## 10       10  42.8  0.06 (0.06 42.85)
```

---

# Show our scratch sf object from points


```r
ggplot() +
  geom_sf(data=studysites) + 
  geom_sf(data=sf_pts) +
  labs(title = 'Monitoring sites and random points')
```

&lt;img src="index_files/figure-html/unnamed-chunk-53-1.png" style="display: block; margin: auto;" /&gt;

---

# HOWTO : subset points that intersects polygons

* the geometric predicate `st_intersects` tells us which polygon intersects which point
* we need input objects with the same CRS
* if there is no polygon intersected, the result is empty


```r
sf_pts &lt;- sf_pts %&gt;% 
  st_transform(st_crs(studysites))
*result &lt;- st_intersects(sf_pts, studysites)
result
```

```
## Sparse geometry binary predicate list of length 10, where the predicate was `intersects'
##  1: 42
##  2: 53
##  3: (empty)
##  4: 97
##  5: 50
##  6: 109
##  7: (empty)
##  8: 74
##  9: 46
##  10: 38
```

---

# HOWTO : subset points that intersects polygons

* the geometric predicate `st_intersects` tells us which polygon intersects which point
* we need input objects with the same CRS
* if there is no polygon intersected, the result is empty


```r
sf_pts &lt;- sf_pts %&gt;% 
  st_transform(st_crs(studysites))
result &lt;- st_intersects(sf_pts, studysites)
*subset_pts &lt;- sf_pts %&gt;%
* add_column(nb_intersected=sapply(result,length)) %&gt;%
* filter(nb_intersected &gt; 0)
```

---

# Highlight points intersecting polygons


```r
ggplot() +
  geom_sf(data=studysites) + 
  geom_sf(data=sf_pts) +
  geom_sf(data=subset_pts, color="red") +
  labs(title = 'Monitoring sites and random points')
```

&lt;img src="index_files/figure-html/unnamed-chunk-56-1.png" style="display: block; margin: auto;" /&gt;

---

# HOW TO : Make grid

* Let's create an hexagonal grid with 10 km cells covering the studysites area


```r
*hex_grid &lt;- st_make_grid(studysites, cellsize=10000, square=FALSE)
ggplot() +
  geom_sf(data=studysites, color=NA, fill="blue", alpha=0.4) + 
  geom_sf(data=hex_grid, fill=NA, lwd=0.2) +
  labs(title = 'Making hexagonal grid')
```

&lt;img src="index_files/figure-html/unnamed-chunk-57-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse, middle, center
# Wrap up
---


## Geometric calculations

**Geometric operations** on vector layers can conceptually be divided into **three groups** according to their output:

* **Numeric** values: Functions that summarize geometrical properties of: 
    * A **single layer** (e.g. area, length)
    * A **pair of layers** (e.g. distance)
    
* **Logical** values: Functions that evaluate whether a certain condition holds true, regarding:
    * A **single layer** (e.g. geometry is valid) 
    * A **pair of layers** (e.g. feature A intersects feature B)
    
* **Spatial** layers: Functions that create a new layer based on: 
    * A **single layer** (e.g. centroids) 
    * A **pair of layers** (e.g. intersection area)

---

## Numeric

* Several functions to calculate **numeric geometric properties** of vector layers: 
    * `st_length`
    * `st_area`
    * `st_distance`
    * `st_bbox`
    * ...

---

## Logical

* Given two layers, `x` and `y`, the following **logical geometric functions** check whether each feature in `x` maintains the specified **relation** with each feature in `y`:
    * `st_intersects`
    * `st_disjoint`
    * `st_touches`
    * `st_crosses`
    * `st_within`
    * `st_contains`
    * `st_overlaps`
    * `st_covers`
    * `st_equals`
    * ...

---

## Spatial

* Common **geometry-generating** functions applicable to **individual** geometries:
    * `st_centroid`
    * `st_buffer`
    * `st_union`
    * `st_sample`
    * `st_convex_hull`
    * `st_voronoi`
    * ...
    
    
    
---

## All `sf` methods


```
##   [1] [                     [[&lt;-                  $&lt;-                  
##   [4] aggregate             anti_join             arrange              
##   [7] as.data.frame         cbind                 coerce               
##  [10] dbDataType            dbWriteTable          distinct             
##  [13] dplyr_reconstruct     filter                full_join            
##  [16] gather                group_by              group_split          
##  [19] identify              initialize            inner_join           
##  [22] left_join             mapView               merge                
##  [25] mutate                nest                  plot                 
##  [28] print                 rbind                 rename               
##  [31] right_join            rowwise               sample_frac          
##  [34] sample_n              select                semi_join            
##  [37] separate_rows         separate              show                 
##  [40] slice                 slotsFromS3           spread               
##  [43] st_agr                st_agr&lt;-              st_area              
##  [46] st_as_s2              st_as_sf              st_bbox              
##  [49] st_boundary           st_buffer             st_cast              
##  [52] st_centroid           st_collection_extract st_convex_hull       
##  [55] st_coordinates        st_crop               st_crs               
##  [58] st_crs&lt;-              st_difference         st_filter            
##  [61] st_geometry           st_geometry&lt;-         st_inscribed_circle  
##  [64] st_interpolate_aw     st_intersection       st_intersects        
##  [67] st_is_valid           st_is                 st_join              
##  [70] st_line_merge         st_m_range            st_make_valid        
##  [73] st_nearest_points     st_node               st_normalize         
##  [76] st_point_on_surface   st_polygonize         st_precision         
##  [79] st_reverse            st_sample             st_segmentize        
##  [82] st_set_precision      st_shift_longitude    st_simplify          
##  [85] st_snap               st_sym_difference     st_transform         
##  [88] st_triangulate        st_union              st_voronoi           
##  [91] st_wrap_dateline      st_write              st_z_range           
##  [94] st_zm                 summarise             transform            
##  [97] transmute             ungroup               unite                
## [100] unnest               
## see '?methods' for accessing help and source code
```


---
class: inverse, middle, center
# To go further
---


# To dive even deeper into sf

* Detailed sf package [vignettes](https://r-spatial.github.io/sf/articles/)

* Blog posts: [here](https://www.r-spatial.org/r/2016/02/15/simple-features-for-r.html), [here](https://www.r-spatial.org/r/2016/07/18/sf2.html), [here](https://www.r-spatial.org/r/2016/11/02/sfcran.html), [here](https://www.r-spatial.org/r/2017/01/12/newssf.html) and [there](https://statnmap.com/fr/2018-07-14-initiation-a-la-cartographie-avec-sf-et-compagnie/) (in French)

* [wiki page](https://github.com/r-spatial/sf/wiki/Migrating) describing sp-sf migration

* Awesome online book [Geocomputation with R](https://geocompr.robinlovelace.net/) by Lovelace, Nowosad and Muenchow

&lt;img src="img/lovelacebookcover.png" width="150px" style="display: block; margin: auto;" /&gt;

---

# The [RStudio Cheat Sheets](https://www.rstudio.com/resources/cheatsheets/)

&lt;img src="img/sf_Page_1.png" width="600px" style="display: block; margin: auto;" /&gt;

---

# The [RStudio Cheat Sheets](https://www.rstudio.com/resources/cheatsheets/)

&lt;img src="img/sf_Page_2.png" width="600px" style="display: block; margin: auto;" /&gt;


---
class: title-slide-final, middle
background-size: 55px
background-position: 9% 15%

# Thanks!

### I created these slides with [xaringan](https://github.com/yihui/xaringan) and [RMarkdown](https://rmarkdown.rstudio.com/) using the [rutgers css](https://github.com/jvcasillas/ru_xaringan) that I slightly modified.

### Credits: I used material from @StrimasMackey, @jafflerbach, @StatnMap, @SharpSightLabs and @edzerpebesma 


|                                                                                                            |                                   |
| :--------------------------------------------------------------------------------------------------------- | :-------------------------------- |
| &lt;svg viewBox="0 0 512 512" style="height:1em;position:relative;display:inline-block;top:.1em;" xmlns="http://www.w3.org/2000/svg"&gt;  &lt;path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"&gt;&lt;/path&gt;&lt;/svg&gt; | **olivier.gimenez@cefe.cnrs.fr**       |
| &lt;svg viewBox="0 0 576 512" style="height:1em;position:relative;display:inline-block;top:.1em;" xmlns="http://www.w3.org/2000/svg"&gt;  &lt;path d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"&gt;&lt;/path&gt;&lt;/svg&gt; | [**https://oliviergimenez.github.io/**](https://oliviergimenez.github.io/) |
| &lt;svg viewBox="0 0 512 512" style="height:1em;position:relative;display:inline-block;top:.1em;" xmlns="http://www.w3.org/2000/svg"&gt;  &lt;path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"&gt;&lt;/path&gt;&lt;/svg&gt; | [**@oaggimenez**](https://twitter.com/oaggimenez)                         |
| &lt;svg viewBox="0 0 496 512" style="height:1em;position:relative;display:inline-block;top:.1em;" xmlns="http://www.w3.org/2000/svg"&gt;  &lt;path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"&gt;&lt;/path&gt;&lt;/svg&gt; | [**@oliviergimenez**](https://github.com/oliviergimenez)

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
